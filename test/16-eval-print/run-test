#! /usr/bin/env bash

[ "${TRACE}" = 'YES' ] && set -x

if [ ! -z "${ZSH_VERSION}" ]
then
   setopt sh_word_split
fi


expect_output()
{
   local output="$1"
   local expected="$2"

   if [ "${output}" != "${expected}" ]
   then
      echo "Got \"${output}\". Expected: \"${expected}\"" >&2
      stacktrace >&2
      exit 1
   fi
}


fail()
{
   echo "Unexpected failure" >&2
   stacktrace >&2
   exit 1
}



expanded_string()
{
   r_expanded_string "$*"
   echo "${RVAL}"
}


main()
{
   local a

   a="abc";

   expect_output  "$(expanded_string '')"                   ''
   expect_output  "$(expanded_string 'a')"                  'a'
   expect_output  "$(expanded_string '${a}')"               'abc'
   expect_output  "$(expanded_string '${b}')"               ''
   expect_output  "$(expanded_string '${b:-abc}')"          'abc'
   expect_output  "$(expanded_string '`danger`${a}')"       '`danger`abc'
   expect_output  "$(expanded_string 'x$(danger)${a}y')"    'x$(danger)abcy'

   echo "All tests passed" >&2
}


init()
{
   MULLE_BASHFUNCTIONS_LIBEXEC_DIR="${MULLE_BASHFUNCTIONS_LIBEXEC_DIR:-../../src}"

   . "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-bashglobal.sh" || exit 1
   . "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-compatibility.sh" || exit 1
   . "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-string.sh" || exit 1
   . "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-logging.sh" || exit 1
}


init "$@"
main "$@"

